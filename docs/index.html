<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Zig Engine - Terminal Game</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        h1 {
            color: #00ffff;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ffff;
        }
        
        #game-terminal {
            background-color: #000;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.2;
            width: 90vw;
            max-width: 1000px;
            height: 600px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        #status {
            margin: 10px 0;
            padding: 15px;
            background-color: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
            width: 90vw;
            max-width: 1000px;
            box-sizing: border-box;
        }
        
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .loading { color: #ffff44; }
        
        pre {
            margin: 0;
            white-space: pre;
            font-family: inherit;
            color: inherit;
        }
        
        .controls {
            margin: 10px 0;
            padding: 15px;
            background-color: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
            width: 90vw;
            max-width: 1000px;
            box-sizing: border-box;
        }
        
        .blinking-cursor {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        #game-terminal:focus {
            outline: 2px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <h1>üéÆ Zig Engine - Terminal Game</h1>
    
    <div class="controls">
        <strong>üéØ Controls:</strong> WASD to move ‚Ä¢ Q or ESC to quit ‚Ä¢ Click terminal to focus
        <br><strong>üí° Tip:</strong> Make sure to click on the black terminal area below to capture keyboard input!
    </div>
    
    <div id="status" class="loading">üîÑ Loading WebAssembly module...</div>
    <div id="game-terminal" tabindex="0">
        <pre id="terminal-content"></pre>
        <span class="blinking-cursor">‚ñà</span>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const terminalEl = document.getElementById('game-terminal');
        const contentEl = document.getElementById('terminal-content');
        
        let wasmModule = null;
        let wasmMemory = null;
        let isGameRunning = false;
        
        // Terminal state
        let terminalBuffer = '';
        let cursorX = 0;
        let cursorY = 0;
        
        // Focus terminal for input
        terminalEl.focus();
        
        // Handle clicks to refocus
        terminalEl.addEventListener('click', () => {
            terminalEl.focus();
        });
        
        // Keyboard input handler
        terminalEl.addEventListener('keydown', function(event) {
            if (!isGameRunning) return;
            
            event.preventDefault();
            event.stopPropagation();
            
            let keyCode = 0;
            
            // Handle special keys
            switch(event.key) {
                case 'Escape': keyCode = 27; break;
                case 'Enter': keyCode = 13; break;
                case 'Backspace': keyCode = 8; break;
                case 'Tab': keyCode = 9; break;
                case 'ArrowUp': keyCode = 65; break;    // Convert to 'A'
                case 'ArrowDown': keyCode = 83; break;  // Convert to 'S'  
                case 'ArrowLeft': keyCode = 65; break;  // Convert to 'A'
                case 'ArrowRight': keyCode = 68; break; // Convert to 'D'
                default:
                    if (event.key.length === 1) {
                        keyCode = event.key.toUpperCase().charCodeAt(0);
                    }
            }
            
            if (keyCode > 0 && wasmModule && wasmModule.exports.wasm_handle_input) {
                try {
                    wasmModule.exports.wasm_handle_input(keyCode);
                    console.log('Input sent:', String.fromCharCode(keyCode));
                } catch (e) {
                    console.error('Error processing input:', e);
                }
            }
        });
        
        // Terminal emulation functions
        function updateTerminal(text) {
            // Handle ANSI escape sequences and terminal control
            if (text.includes('\x1b[H')) {
                // Clear screen and home cursor
                terminalBuffer = '';
                cursorX = 0;
                cursorY = 0;
                text = text.replace('\x1b[H', '');
            }
            
            // Remove other ANSI sequences for now (color codes, etc.)
            text = text.replace(/\x1b\[[0-9;]*m/g, '');
            text = text.replace(/\x1b\?\d+[hl]/g, '');
            
            terminalBuffer += text;
            contentEl.textContent = terminalBuffer;
            
            // Auto-scroll if needed
            terminalEl.scrollTop = terminalEl.scrollHeight;
        }
        
        // WASM import object
        const wasmImports = {
            env: {
                // Console output for the game
                consoleWrite: function(ptr, len) {
                    if (wasmModule && wasmModule.exports.memory) {
                        const bytes = new Uint8Array(wasmModule.exports.memory.buffer, ptr, len);
                        const text = new TextDecoder().decode(bytes);
                        updateTerminal(text);
                    }
                },
                
                consoleLog: function(ptr, len) {
                    if (wasmModule && wasmModule.exports.memory) {
                        const bytes = new Uint8Array(wasmModule.exports.memory.buffer, ptr, len);
                        const text = new TextDecoder().decode(bytes);
                        console.log('WASM:', text);
                        statusEl.textContent = text;
                    }
                },
                
                // Memory for WASM
                memory: new WebAssembly.Memory({ 
                    initial: 17,  // 17 * 64KB = ~1MB
                    maximum: 100  // Max 100 pages = ~6MB
                })
            }
        };
        
        // Load and run WASM
        async function loadAndRunGame() {
            try {
                statusEl.textContent = 'üì• Fetching WASM module...';
                
                const response = await fetch('main.wasm');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                statusEl.textContent = '‚öôÔ∏è Compiling WebAssembly...';
                const wasmBytes = await response.arrayBuffer();
                
                statusEl.textContent = 'üöÄ Starting game engine...';
                const wasmObj = await WebAssembly.instantiate(wasmBytes, wasmImports);
                
                wasmModule = wasmObj.instance;
                wasmMemory = wasmImports.env.memory;
                
                // Start the game
                if (wasmModule.exports.main) {
                    statusEl.textContent = '‚úÖ Game loaded! Click terminal and use WASD to play.';
                    statusEl.className = 'success';
                    
                    isGameRunning = true;
                    terminalEl.focus();
                    
                    // Run the game
                    try {
                        wasmModule.exports.main();
                    } catch (e) {
                        if (e.message && e.message.includes('unreachable')) {
                            console.log('Game ended normally');
                        } else {
                            throw e;
                        }
                    }
                } else {
                    throw new Error('No main function found in WASM module');
                }
                
            } catch (error) {
                console.error('Failed to load game:', error);
                statusEl.textContent = `‚ùå Failed to load: ${error.message}`;
                statusEl.className = 'error';
                
                // Show some helpful debugging info
                contentEl.innerHTML = `
<strong>Debug Info:</strong>
Error: ${error.message}
URL: ${window.location.href}
WASM file should be at: ${window.location.origin}${window.location.pathname}main.wasm

<strong>Troubleshooting:</strong>
1. Make sure main.wasm exists in the docs/ folder
2. Check browser console for more details
3. Verify the WASM file was built correctly

<strong>Build command:</strong>
zig build-exe src/main.zig -target wasm32-freestanding -O ReleaseSmall --name main
                `;
            }
        }
        
        // Start when page loads
        window.addEventListener('load', loadAndRunGame);
        
        // Handle page focus
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && isGameRunning) {
                terminalEl.focus();
            }
        });
    </script>
</body>
</html>
